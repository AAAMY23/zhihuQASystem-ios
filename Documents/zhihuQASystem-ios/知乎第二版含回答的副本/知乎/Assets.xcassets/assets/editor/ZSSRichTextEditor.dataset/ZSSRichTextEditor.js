/*!
 *
 * ZSSRichTextEditor v1.0
 * http://www.zedsaid.com
 *
 * Copyright 2013 Zed Said Studio
 *
 * 感谢ZSSRichTextEditor的基础框架，在此基础上完成了：跨平台整合、功能精简/优化、bugs修复、个性化API实现
 * --2015.12.28
*/
;var ua=navigator.userAgent;var isUsingAndroid=/Android/i.test(ua);var editorFeature=editorFeature||{};var androidVersion=0;var defaultCallbackSeparator="~";var NodeName={BLOCKQUOTE:"BLOCKQUOTE",PARAGRAPH:"P"};var ZSSEditor={};ZSSEditor.caretArguments=["yOffset="+0,"height="+0];ZSSEditor.caretInfo={y:0,height:0};ZSSEditor.currentSelection;ZSSEditor.focusedField=null;ZSSEditor.editableFields={};ZSSEditor.defaultParagraphSeparator="p";ZSSEditor.editorZoneId="zss_field_content";ZSSEditor.init=function(){ZSSEditor.$editor=$("#"+ZSSEditor.editorZoneId);if(isUsingAndroid){ZSSEditor.$editor.addClass("android");var a=/Android\s(\d.\d)/i.exec(ua);if(a){androidVersion=parseFloat(a[1])}}rangy.init();document.execCommand("insertBrOnReturn",false,false);document.execCommand("defaultParagraphSeparator",false,this.defaultParagraphSeparator);document.execCommand("styleWithCSS",false,true);var c=$("div.field").each(function(){var e=new ZSSField($(this));var f=e.getNodeId();ZSSEditor.editableFields[f]=e;ZSSEditor.callback("callback-new-field","id="+f)});var d;var b=0;document.addEventListener("selectionchange",function(g){var f=new Date().getTime();clearTimeout(d);d=setTimeout(function(){if(c.is(":focus")){ZSSEditor.selectionChangedCallback();ZSSEditor.sendEnabledStyles(g)}},300)},false);$("[contenteditable]").on("paste",function(i){var h="";try{var f=i.originalEvent||i;h=f.clipboardData.getData("text/plain")||f.clipboardData.getData("text");if(!h){return}var j=$("<div></div>");j.html(h);ZSSEditor.insertHTML(j.text());i.preventDefault()}catch(g){}});this.domLoadedCallback()};ZSSEditor.callback=function(d,a){var b=d+":";if(a){b=b+a}if(isUsingAndroid){try{nativeCallbackHandler.executeCallback(d,a)}catch(c){}}else{ZSSEditor.callbackThroughIFrame(b)}};ZSSEditor.callbackThroughIFrame=function(a){var b=document.createElement("IFRAME");b.setAttribute("src",a);b.style.cssText="border: 0px transparent;";document.documentElement.appendChild(b);b.parentNode.removeChild(b);b=null};ZSSEditor.domLoadedCallback=function(){this.callback("callback-dom-loaded")};ZSSEditor.selectionChangedCallback=function(){var a=this.getJoinedFocusedFieldIdAndCaretArguments();this.callback("callback-selection-changed",a)};ZSSEditor.stylesCallback=function(a){var b="";if(a.length>0){b=a.join(defaultCallbackSeparator)}ZSSEditor.callback("callback-selection-style",b)};ZSSEditor.log=function(a){ZSSEditor.callback("callback-log","msg="+a)};ZSSEditor.refreshVisibleViewportSize=function(){var b=window.innerHeight,c=ZSSEditor.$editor.position().top,a=b-c;$(document.body).css("min-height",b+"px");ZSSEditor.$editor.css("min-height",a+"px")};ZSSEditor.focusFirstEditableField=function(){$("div[contenteditable=true]:first").focus()};ZSSEditor.getField=function(a){a=a||this.editorZoneId;var b=this.editableFields[a];return b};ZSSEditor.getFocusedField=function(){return this.getField()};ZSSEditor.backupRange=function(){var f=window.getSelection();if(f.rangeCount){var c=f.getRangeAt(0);var b=c.startOffset,d=c.endOffset,e,g,a;if(c.startContainer.textContent===c.endContainer.textContent){g=c.startContainer.textContent;for(e=0,a=b;e<a;e++){if(/[\u2006]/.test(g.charAt(e))){b--;d--}}if(d>b){for(e=b,a=d;e<a;e++){if(/[\u2006]/.test(g.charAt(e))){d--}}}}ZSSEditor.currentSelection={startContainer:c.startContainer,startOffset:b,endContainer:c.endContainer,endOffset:d}}};ZSSEditor.restoreRange=function(){if(this.currentSelection){var b=window.getSelection();var a=document.createRange();try{if(!this.currentSelection.startContainer.parentNode||!this.currentSelection.endContainer.parentNode){return}a.setStart(this.currentSelection.startContainer,this.currentSelection.startOffset);a.setEnd(this.currentSelection.endContainer,this.currentSelection.endOffset)}catch(c){a.setStart(this.currentSelection.startContainer,this.currentSelection.startContainer.textContent.length);a.setEnd(this.currentSelection.endContainer,this.currentSelection.endContainer.textContent.length)}b.removeAllRanges();b.addRange(a);this.currentSelection=undefined}};ZSSEditor.getSelectedText=function(){var a=window.getSelection();return a.toString()};ZSSEditor.getCaretArguments=function(){var a=this.getYCaretInfo();if(a==null){return null}else{this.caretArguments[0]="yOffset="+a.y;this.caretArguments[1]="height="+a.height;this.caretArguments[2]="xOffset="+a.x;return this.caretArguments}};ZSSEditor.getJoinedFocusedFieldIdAndCaretArguments=function(){var b=ZSSEditor.getJoinedCaretArguments();var a="id="+ZSSEditor.getFocusedField().getNodeId();b=a+defaultCallbackSeparator+b;return b};ZSSEditor.getJoinedCaretArguments=function(){var b=this.getCaretArguments();var a=this.caretArguments.join(defaultCallbackSeparator);return a};ZSSEditor.getCaretYPosition=function(){var c=window.getSelection();var a=c.getRangeAt(0);var b=document.createElement("span");b.appendChild(document.createTextNode("\u200b"));a.insertNode(b);var e=b.offsetTop;var d=b.parentNode;d.removeChild(b);d.normalize();return e};ZSSEditor.getYCaretInfo=function(){var i=window.getSelection();var c=i.rangeCount==0;if(c){return null}var f=0,g;var k=0;var d=i.getRangeAt(0);var b=(d.getClientRects().length==0);if(b){var a=ZSSEditor.closerParentNode();var l=$(a).css("font-size");var h=Math.floor(parseInt(l.replace("px",""))*1.5);f=this.getCaretYPosition();k=h}else{if(d.getClientRects){var j=d.getClientRects();if(j.length>0){var e=document.body.getClientRects()[0].top<0;if(e){f=document.body.scrollTop}f+=j[0].top;k=j[0].height;g=j[0].left}}}this.caretInfo.y=f;this.caretInfo.x=g;this.caretInfo.height=k;return this.caretInfo};ZSSEditor.defaultParagraphSeparatorTag=function(){return"<"+this.defaultParagraphSeparator+">"};ZSSEditor.setBold=function(){document.execCommand("bold",false,null);ZSSEditor.sendEnabledStyles()};ZSSEditor.setItalic=function(){document.execCommand("italic",false,null);ZSSEditor.sendEnabledStyles()};ZSSEditor.setUnderline=function(){document.execCommand("underline",false,null);ZSSEditor.sendEnabledStyles()};ZSSEditor.setOrderedList=function(){document.execCommand("insertOrderedList",false,null);ZSSEditor.sendEnabledStyles();fixListElement()};function fixListElement(){ZSSEditor.$editor.find("ol,ul").each(function(c,f){var e=f.parentNode;if(e.tagName=="P"&&e.lastChild===e.firstChild){$(f).children().each(function(h,g){var i=e.cloneNode(false);$(i).append(g.innerHTML);$(g).html("").append(i.innerHTML)});$(f).insertBefore(e);$(e).remove();var a=$(f).find("li");if(a.length){a=a[a.length-1];var b=document.createRange();b.setStartAfter(a);var d=window.getSelection();d.removeAllRanges();d.addRange(b)}}})}ZSSEditor.setUnorderedList=function(){document.execCommand("insertUnorderedList",false,null);ZSSEditor.sendEnabledStyles();fixListElement()};ZSSEditor.setBlockQuote=function(){var b=getTopParent();if(!b){return}var c=b.nodeName.toLowerCase();var a;if(c==="blockquote"){a=document.createElement("p");a.innerHTML=b.innerHTML;b.parentNode.replaceChild(a,b);focusElement(a)}else{if(c==="ul"||c==="ol"){if(document.queryCommandValue("formatBlock")==="blockquote"){document.execCommand("formatBlock",false,"p")}else{document.execCommand("formatBlock",false,"blockquote")}}else{a=document.createElement("blockquote");a.innerHTML=b.innerHTML;b.parentNode.replaceChild(a,b);focusElement(a)}}ZSSEditor.sendEnabledStyles()};ZSSEditor.setH1=function(){var c=getTopParent();if(!c){return}var d=c.nodeName.toLowerCase();var b;var a=document.createRange();if(d==="h1"){b=document.createElement("p");b.innerHTML=c.innerHTML;c.parentNode.replaceChild(b,c);focusElement(b)}else{if(d==="ul"||d==="ol"){if(document.queryCommandValue("formatBlock")==="h1"){document.execCommand("formatBlock",false,"p")}else{document.execCommand("formatBlock",false,"h1")}}else{b=document.createElement("h1");b.innerHTML=c.innerHTML;c.parentNode.replaceChild(b,c);focusElement(b)}}ZSSEditor.sendEnabledStyles()};function focusElement(c){var b=window.getSelection();var a=document.createRange();a.setStart(c,1);b.removeAllRanges();b.addRange(a)}function getTopParent(){var b=ZSSEditor.closerParentNode();if(!b){return null}var a=0;while(true){if(!b.parentNode){return null}if(b.parentNode.id===ZSSEditor.editorZoneId||a===6){break}b=b.parentNode;a++}return b}ZSSEditor.insertLink=function(a,b){ZSSEditor.insertHTML('<a  href="'+a+'">'+b+"</a>")};ZSSEditor.insertHr=function(){ZSSEditor.insertHTML("<hr/>");ZSSEditor.insertHTML("<p><br/></p>")};ZSSEditor.insertImage=function(a,h,m){var n=window.getSelection();if(n.rangeCount<1){return}var i=this,l=this.getFocusedField();l.wrapCaretInParagraphIfNecessary();var k=document.createDocumentFragment("div"),b=document.createElement("br"),j=document.createElement("br"),f=document.createElement("img"),c=document.createTextNode("\u200b"),g=n.getRangeAt(0).cloneRange(),d=g.startContainer;if($(d).closest("a").length){g=document.createRange();g.setStartAfter($(d).closest("a")[0])}var e=function(){if(d.nodeType==3&&g.startOffset!=0){k.appendChild(b)}k.appendChild(f);k.appendChild(j);k.appendChild(c);g.insertNode(k);g.selectNodeContents(c);g.collapse(true);n.removeAllRanges();n.addRange(g);if(isUsingAndroid){var r=f.offsetTop,p=f.offsetHeight,o=r+p;setTimeout(function(){window.scrollTo(0,o)},300)}i.sendEnabledStyles();var q=ZSSEditor.getJoinedFocusedFieldIdAndCaretArguments();i.callback("callback-input",q);ZSSEditor.selectionChangedCallback()};if(m){e()}else{f.onload=e}f.src=a;return};ZSSEditor.insertVideo=function(b,m,f,i){var o=window.getSelection();if(o.rangeCount<1){return}var j=this,n=this.getFocusedField();n.wrapCaretInParagraphIfNecessary();var l=document.createDocumentFragment("div"),a=document.createElement("br"),k=document.createElement("br"),d=document.createElement("video");var c=document.createTextNode("\u200b");var g=document.createElement("i");var h=o.getRangeAt(0).cloneRange();var e=h.startContainer;setTimeout(function(){if(e.nodeType==3&&h.startOffset!=0){l.appendChild(a)}before_text=document.createElement("p");before_text.innerHTML="video:";before_text.className="video_placeholder";before_text.style.display="none";g.className="delete-icon";g.setAttribute("data-node","delete-video");g.setAttribute("contenteditable",false);d.setAttribute("contenteditable",false);d.setAttribute("poster",f);d.setAttribute("data-poster",i);d.setAttribute("data-vid",m);d.setAttribute("controls",true);l.appendChild(before_text);l.appendChild(d);d.src=b;var r=h.endContainer;if($(r).closest("a").length){r=$(r).closest("a");if($.contains(n.wrappedObject[0],r[0])){$(l).insertAfter(r)}else{$(l).appendTo(n.wrappedObject)}}else{h.insertNode(l)}var s=$("<p>\u200b</p>");s.insertAfter($(d.parentNode));h.selectNodeContents(s[0]);h.collapse(true);o.removeAllRanges();o.addRange(h);var t=ZSSEditor.getJoinedFocusedFieldIdAndCaretArguments();j.callback("callback-input",t);if(isUsingAndroid){var u=d.offsetTop,q=d.offsetHeight,p=u+q;setTimeout(function(){window.scrollTo(0,p)},300)}j.sendEnabledStyles();ZSSEditor.selectionChangedCallback()},50);return};ZSSEditor.setNewLineBeforeInsertImageIfNecessary=function(){var c=window.getSelection();if(c.rangeCount){var b=c.getRangeAt(0);if(b.commonAncestorContainer.nodeType==3){var e=document.createElement("br"),d=e.cloneNode(),a=document.createRange();b.insertNode(e);b.insertNode(d);a.selectNode(e);c.removeAllRanges();c.addRange(a)}}};ZSSEditor.setNewLineAfterImageNodeIfNecessary=function(){var c=window.getSelection();if(c.rangeCount){var b=c.getRangeAt(0),g=b.endContainer,d=b.endOffset;if(g.nodeType==1&&d>0){var f=g.childNodes[d-1];if(f.nodeName.toLowerCase()=="img"){var e=document.createElement("br"),a=document.createRange();b.insertNode(e);a.setStartAfter(e);c.removeAllRanges();c.addRange(a)}}}};ZSSEditor.insertHTML=function(a){var b=this.getFocusedField();b.wrapCaretInParagraphIfNecessary();document.execCommand("insertHTML",false,a);this.sendEnabledStyles()};ZSSEditor.insertText=function(a){var b=this.getFocusedField();b.wrapCaretInParagraphIfNecessary();document.execCommand("insertText",false,a);this.sendEnabledStyles()};ZSSEditor.isCommandEnabled=function(a){return document.queryCommandState(a)};ZSSEditor.sendEnabledStyles=function(d){var b=[];var c=this.getFocusedField();if(!c.hasNoStyle){if(ZSSEditor.isCommandEnabled("bold")){b.push("bold")}if(ZSSEditor.isCommandEnabled("createLink")){b.push("createLink")}if(ZSSEditor.isCommandEnabled("italic")){b.push("italic")}if(ZSSEditor.isCommandEnabled("subscript")){b.push("subscript")}if(ZSSEditor.isCommandEnabled("superscript")){b.push("superscript")}if(ZSSEditor.isCommandEnabled("strikeThrough")){b.push("strikeThrough")}if(ZSSEditor.isCommandEnabled("underline")){b.push("underline")}if(ZSSEditor.isCommandEnabled("insertOrderedList")){b.push("orderedList")}if(ZSSEditor.isCommandEnabled("insertUnorderedList")){b.push("unorderedList")}if(ZSSEditor.isCommandEnabled("justifyCenter")){b.push("justifyCenter")}if(ZSSEditor.isCommandEnabled("justifyFull")){b.push("justifyFull")}if(ZSSEditor.isCommandEnabled("justifyLeft")){b.push("justifyLeft")}if(ZSSEditor.isCommandEnabled("justifyRight")){b.push("justifyRight")}if(ZSSEditor.isCommandEnabled("insertHorizontalRule")){b.push("horizontalRule")}var a=document.queryCommandValue("formatBlock");if(a.length>0){b.push(a)}}ZSSEditor.stylesCallback(b)};ZSSField.prototype.getEnabledStyles=function(){var c={bold:0,orderedList:0,underline:0,unorderedList:0,h1:0,blockquote:0};var a=ZSSEditor.getFocusedField();if(!a.hasNoStyle){if(ZSSEditor.isCommandEnabled("bold")){c.bold=1}if(ZSSEditor.isCommandEnabled("underline")){c.underline=1}if(ZSSEditor.isCommandEnabled("insertOrderedList")){c.orderedList=1}if(ZSSEditor.isCommandEnabled("insertUnorderedList")){c.unorderedList=1}var b=getTopParent();if(b){if(b.nodeName.toLowerCase()==="blockquote"){c.blockquote=1}else{if(document.queryCommandValue("formatBlock")=="blockquote"){c.blockquote=1}}if(b.nodeName.toLowerCase()==="h1"){c.h1=1}else{if(document.queryCommandValue("formatBlock")=="h1"){c.h1=1}}}}return JSON.stringify(c)};ZSSField.prototype.getEnabledStylesForCallback=function(){var b="function=getEnabledStylesForCallback";var a="id="+this.getNodeId();var d="contents="+this.getEnabledStyles();var c=b+defaultCallbackSeparator+a+defaultCallbackSeparator+d;ZSSEditor.callback("callback-response-string",c)};ZSSEditor.closerParentNode=function(){var a=null;var d=window.getSelection();if(d.rangeCount){var b=d.getRangeAt(0).cloneRange();var c=b.commonAncestorContainer;while(c){if(c.nodeType==document.ELEMENT_NODE){a=c;break}c=c.parentElement}}return a};function ZSSField(a){this.wrappedObject=a;this.isComposing=false;this.multiline=true;this.prepareToWriteContentFromEmptyEditor=true;this.bindListeners()}ZSSField.prototype.bindListeners=function(){var a=this;this.wrappedObject.bind("tap",function(b){a.handleTapEvent(b)});this.wrappedObject.bind("focus",function(b){a.handleFocusEvent(b)});this.wrappedObject.bind("blur",function(b){a.handleBlurEvent(b)});this.wrappedObject.bind("keydown",function(b){a.handleKeyDownEvent(b)});this.wrappedObject.bind("keyup",function(b){a.handleKeyUpEvent(b)});this.wrappedObject.bind("input",function(b){a.handleInputEvent(b)});this.wrappedObject.bind("compositionstart",function(b){a.handleCompositionStartEvent(b)});this.wrappedObject.bind("compositionend",function(b){a.handleCompositionEndEvent(b)});$("body").bind("tap",function(b){a.handleClick(b)})};ZSSField.prototype.emptyFieldIfNoContents=function(){var c=this.wrappedObject.text().replace(/[\s\u00a0\u200b]/g,""),b=false;if(c.length==0){var a=(this.wrappedObject.find("img").length>0||this.wrappedObject.find("video").length>0);if(!a){this.wrappedObject.empty();b=true}}return b};ZSSField.prototype.handleBlurEvent=function(a){ZSSEditor.focusedField=null;this.emptyFieldIfNoContents();this.callback("callback-focus-out")};ZSSField.prototype.handleFocusEvent=function(a){ZSSEditor.focusedField=this;this.callback("callback-focus-in")};var removeVideoInterval;ZSSField.prototype.handleKeyDownEvent=function(h){var i=(h.keyCode==13),f=(h.keyCode==8),b=h.keyCode==32;var g=this;if(this.isComposing){h.stopPropagation()}else{if(i&&!this.isMultiline()){h.preventDefault()}else{if(this.isMultiline()&&!f&&!i){if(!isUsingAndroid){this.wrapCaretInParagraphIfNecessary()}}}}if(f){clearTimeout(removeVideoInterval);var l=window.getSelection();var d=l.getRangeAt(0);if(this.isOutLink(d.endContainer)||(d.startContainer.previousSibling&&this.isOutLink(d.startContainer.previousSibling)&&this.isEmptyRange(d)&&(d.startOffset==0||(d.startOffset==1&&d.startContainer.data=="\u200b")))){var k=d.startContainer.previousSibling;k.parentNode.removeChild(k);return}var c=ZSSEditor.getJoinedFocusedFieldIdAndCaretArguments();function j(o){if(!o){return}var n=window.getSelection();var e=document.createRange();e.setStartAfter(o);e.setEndAfter(o);n.removeAllRanges();n.addRange(e)}if(this.isLinkAt(d.startContainer)&&d.startOffset!=0){j(d.startContainer.previousSibling);$(d.startContainer).remove();this.callback("callback-input",c);h.preventDefault();this.emptyFieldIfNoContents();return}else{if(this.isLinkAt(d.startContainer.parentNode)&&d.startOffset!=0){j(d.startContainer.parentNode.previousSibling);$(d.startContainer.parentNode).remove();this.callback("callback-input",c);h.preventDefault();this.emptyFieldIfNoContents();return}}if(this.isLinkAt(d.startContainer.previousSibling)&&d.startOffset==0){j(d.startContainer.previousSibling.previousSibling);$(d.startContainer.previousSibling).remove();this.callback("callback-input",c);h.preventDefault();this.emptyFieldIfNoContents();return}if(d.startContainer.tagName=="P"){var a=d.startContainer.lastChild;if(this.isLinkAt(a)){$(a).remove();this.callback("callback-input",c);h.preventDefault();this.emptyFieldIfNoContents();return}}removeVideoInterval=setTimeout(function(){var q=window.getSelection();var p=q.getRangeAt(0);if(isUsingAndroid){if(p.startContainer.previousSibling&&p.startContainer.previousSibling.tagName=="VIDEO"){console.log("deleteVideo");var o=p.startContainer.previousSibling;var n=o.getAttribute("data-vid")||"";try{var u=o.previousSibling;if(u.className.indexOf("video_placeholder")!==-1){o.parentNode.removeChild(u)}}catch(t){}o.parentNode.removeChild(o);g.callback("callback-delete-video",[c,"fake_vid="+n].join(defaultCallbackSeparator));g.callback("callback-input",c)}}if(!isUsingAndroid){var r=p.startContainer;if(r&&r.tagName=="P"&&r.previousSibling.tagName=="P"){var o=r.previousSibling;if($(o).find("video").length>0){$(o).find(".video_placeholder").remove();var w=$(o).text();$(o).html("").text(w)}}else{if(r.previousSibling&&r.previousSibling.tagName=="VIDEO"){var o=r.previousSibling.parentNode;$(o).find(".video_placeholder").remove();var w=$(o).text();$(o).html("").text(w)}}}},100);ZSSEditor.backupRange()}else{if(i){this.checkWhetherChangeToLink(true);this.lastParaWrapper=getTopParent()||ZSSEditor.closerParentNode();if(this.lastParaWrapper.nodeName=="BLOCKQUOTE"&&this.lastParaWrapper.innerText.replace(/\s/ig,"")===""){document.execCommand("formatBlock",false,"p");h.preventDefault()}var m=ZSSEditor.getField("zss_field_content").getEnabledStyles();m=JSON.parse(m);if(m.bold){ZSSEditor.setBold()}if(m.underline){ZSSEditor.setUnderline()}if(!this.isComposing&&this.cancelAt()){}}else{this.checkWhetherChangeToLink();if(!this.isComposing&&this.cancelAt()){h.preventDefault()}}}$(".link-edit-tip").remove();$(".editing").removeClass("editing")};ZSSField.prototype.handleKeyUpEvent=function(d){var c=(d.keyCode==13),a=(d.keyCode==8),b=d.keyCode==32;if(c||a){}else{this.checkWhetherChangeToLink();this.checkWhetherPopAt()}};ZSSField.prototype.isOutLink=function(a){return a.className&&a.className.indexOf("out-link")>-1};ZSSField.prototype.isLinkAt=function(a){if(!a){return false}if(a.className&&a.className.indexOf("link-at")>-1){return a}};ZSSField.prototype.isEmptyRange=function(a){return a.startContainer==a.endContainer&&a.startOffset==a.endOffset};ZSSField.prototype.linkCheck=function(){var g=ZSSEditor.closerParentNode();var d=/((http|https)\:\/\/)?[\w\.]*\.(com|edu|gov|mil|net|org|info|us)(\/[^\s]*)?/ig;var h=window.getSelection();if(g.tagName!=="A"){var b=g.lastChild;if(b.nodeType==3){console.log(b);var e=b.nodeValue;if(d.test(e)){e=e.replace(d,function(j){var k=j;if(!/http/.test(k)){k="http://"+k}return'<a href="'+k+'" target="_blank">'+j+"</a>"});var i=document.createElement("div");i.innerHTML=e;while(i.childNodes.length>0){var c=i.childNodes[0];g.insertBefore(c,b)}g.removeChild(b);var f=document.createRange();var a=document.createTextNode(" ");g.appendChild(a);f.selectNodeContents(g.lastChild);f.setStart(a,1);window.sss=f;h.removeAllRanges();h.addRange(f);return true}}}return false};ZSSField.prototype.handleInputEvent=function(c){if(this.isComposing){return}var b=this.emptyFieldIfNoContents();if(b){this.prepareToWriteContentFromEmptyEditor=true}else{if(this.prepareToWriteContentFromEmptyEditor){this.wrapCaretInParagraphIfNecessary();this.prepareToWriteContentFromEmptyEditor=false}}var a=ZSSEditor.getJoinedFocusedFieldIdAndCaretArguments();this.callback("callback-selection-changed",a);this.callback("callback-input",a)};ZSSField.prototype.handleCompositionStartEvent=function(a){this.isComposing=true};ZSSField.prototype.handleCompositionEndEvent=function(b){this.isComposing=false;setTimeout(function(){this.checkWhetherChangeToLink()}.bind(this),10);var a=ZSSEditor.getJoinedFocusedFieldIdAndCaretArguments();this.cancelAt();this.callback("callback-selection-changed",a);this.callback("callback-input",a)};ZSSField.prototype.handleTapEvent=function(h){var g=h.target;if(g&&g.nodeName.toLowerCase()=="img"){var b=window.getSelection(),a=document.createRange(),d=g.nextSibling,f="\u200b";if(!d||d.nodeName.toLowerCase()!="br"){g.insertAdjacentHTML("afterend","<br>\u200b");c=g.nextSibling.nextSibling}else{var c=d.nextSibling;if(!(c&&c.nodeType==3)){d.insertAdjacentHTML("afterend","\u200b");c=d.nextSibling}}a.selectNodeContents(c);a.collapse(true);b.removeAllRanges();b.addRange(a)}};ZSSField.prototype.callback=function(d,a){var b=d+":";b=b+"id="+this.getNodeId();if(a){b=b+defaultCallbackSeparator+a}if(isUsingAndroid){try{nativeCallbackHandler.executeCallback(d,a)}catch(c){}}else{ZSSEditor.callbackThroughIFrame(b)}};ZSSField.prototype.isFocused=function(){return this.wrappedObject.is(":focus")};ZSSField.prototype.focus=function(){if(!this.isFocused()){this.wrappedObject.focus()}};ZSSField.prototype.blur=function(){if(this.isFocused()){this.wrappedObject.blur()}};ZSSField.prototype.isMultiline=function(){return this.multiline};ZSSField.prototype.setMultiline=function(a){this.multiline=a};ZSSField.prototype.getNodeId=function(){return this.wrappedObject.attr("id")};ZSSField.prototype.enableEditing=function(){this.wrappedObject.attr("contenteditable",true);if(!ZSSEditor.focusedField){ZSSEditor.focusFirstEditableField()}};ZSSField.prototype.disableEditing=function(){this.blur();this.wrappedObject.attr("contenteditable",false)};ZSSField.prototype.wrapCaretInParagraphIfNecessary=function(){if(isUsingAndroid&&androidVersion<4.4){return}var l=window.getSelection();if(!l.rangeCount){return}var j=l.getRangeAt(0);var c=ZSSEditor.closerParentNode();var d=(c==this.wrappedDomNode());if(d&&j.endContainer.tagName!="P"){if(l.rangeCount){if(j.startContainer==j.endContainer){if(j.startContainer.nodeType==3){var b=document.createElement("p"),f=j.startContainer,k=j.startOffset,e=document.createRange(),a=document.createRange(),i=null;e.selectNodeContents(f);e.surroundContents(b);i=b.firstChild;a.setStart(i,k);a.setEnd(i,k);l.removeAllRanges();l.addRange(a)}else{var h=document.createElement("p");var g=document.createTextNode("\xa0");h.appendChild(g);j.insertNode(h);j.selectNode(g);l.removeAllRanges();l.addRange(j)}}}}};ZSSField.prototype.isEmpty=function(){var a=this.getHTML();var b=(a.length==0||a=="<br>");return b};ZSSField.prototype.getHTML=function(){var a=this.wrappedObject.html(),b=$("<div>"+a+"</div>");b.find(".video_placeholder").each(function(c,e){var d=$(e);d.remove()});b.find('[data-node="delete-video"]').each(function(c,e){var d=$(e);d.remove()});b.find("p").each(function(c,e){var d=$(e);if(e.innerHTML=="<br>"){d.remove()}});return b.html()};ZSSField.prototype.getHTMLForCallback=function(){var b="function=getHTMLForCallback";var a="id="+this.getNodeId();var d="contents="+this.getHTML();var c=b+defaultCallbackSeparator+a+defaultCallbackSeparator+d;ZSSEditor.callback("callback-response-string",c)};ZSSField.prototype.strippedHTML=function(){return this.wrappedObject.text()};ZSSField.prototype.setPlainText=function(a){this.wrappedObject.text(a)};ZSSField.prototype.processHTML=function(a){a=a||"";a=a.replace(/(<\/a>)(\s*)($|<\/p>|<\/div>)/gi,function(b,e,d,c){return e+"\xa0"+c});return a};ZSSField.prototype.setHTML=function(c,b){var a=this.processHTML(c);this.wrappedObject.html(a);this.focusRangeEnd(b)};ZSSField.prototype.focusRangeEnd=function(b){var j=this.wrappedObject[0],m=window.getSelection(),h=document.createRange(),g=/^[\s\u00a0\u200b]$/,c=j.lastChild,f=false;if(b&&c){var e=false;if(e){h.selectNodeContents(j);h.setStartAfter(j.lastChild)}else{switch(c.nodeType){case 1:l(c);break;case 3:var i=c.nodeValue,d=null;while(i&&i.length==1&&g.test(i)){d=c.previousSibling;i=d?d.nodeValue:""}if(d&&d.nodeType==1){l(d)}break}if(f){c.insertAdjacentHTML("afterend","<br>\u200b");var k=c.nextSibling.nextSibling;h.selectNodeContents(k);h.collapse(true)}else{h.selectNodeContents(j);h.setStartAfter(j.lastChild)}}m.removeAllRanges();m.addRange(h)}else{var a=j.firstChild;if(a){h.selectNodeContents(a);h.collapse(true);m.removeAllRanges();m.addRange(h)}}function l(s){if(s.nodeType!=1){return}var r=s.nodeName.toLowerCase();if(r=="img"||r=="video"){f=true;c=s}else{var p=s.lastChild;if(p){var n=p.nodeName.toLowerCase();if(n=="img"||n=="video"){c=p;f=true}else{if(n=="#text"&&g.test(p.nodeValue)){var q=p.previousSibling;if(!q){return}var o=q.nodeValue;while(o&&o.length==1&&g.test(o)){q=q.previousSibling;o=q?q.nodeValue:""}if(q&&(q.nodeName.toLowerCase()=="img"||q.nodeName.toLowerCase()=="video")){c=q;f=true}}}}}}};ZSSField.prototype.setPlaceholderText=function(a){this.wrappedObject.attr("placeholderText",a)};ZSSField.prototype.wrappedDomNode=function(){return this.wrappedObject[0]};ZSSField.prototype.setBaseFontSize=function(a){this.wrappedObject.css("font-size",a)};ZSSField.prototype.setBaseTextColor=function(a){this.wrappedObject.css("color",a)};ZSSField.prototype.setBaseLineHeight=function(a){this.wrappedObject.css("line-height",a)};ZSSField.prototype.getImageCount=function(){return this.wrappedObject.find("img").length};ZSSField.prototype.getVideoCount=function(){return this.wrappedObject.find("video").length};ZSSField.prototype.getImageCountForCallback=function(){var b="function=getImageCountForCallback";var a="id="+this.getNodeId();var d="contents="+this.getImageCount();var c=b+defaultCallbackSeparator+a+defaultCallbackSeparator+d;ZSSEditor.callback("callback-response-string",c)};ZSSField.prototype.getImages=function(){var a=[];this.wrappedObject.find("img").each(function(){a.push(this.src)});return a.join("|")};ZSSField.prototype.getVideos=function(b){var a=[];this.wrappedObject.find("video").each(function(){if(b===1){a.push({src:this.src,poster:this.getAttribute("poster"),vid:this.getAttribute("data-vid")})}else{a.push(this.src);a.push(this.getAttribute("data-vid"))}});if(b===1){return JSON.stringify(a)}return a.join("|")};ZSSEditor.replaceVideoId=ZSSField.prototype.replaceVideoId=function(c,b){var a=$('[data-vid="'+c+'"]');a.attr("data-vid",b)};ZSSEditor.updatePoster=function(a,c){var b=$('[data-vid="'+a+'"]');b.attr("data-poster",c)};ZSSEditor.deleteVideoById=function(a){var c=$('[data-vid="'+a+'"]');var f=c.prev();var d=c.prev().prev();if(f.hasClass("video_placeholder")||f.data("node")=="delete-video"){f.remove()}if(d.hasClass("video_placeholder")||d.data("node")=="delete-video"){d.remove()}var b=c.next();if(b[0]){if(b[0].nodeName=="BR"||b[0].nodeValue==""){b.remove()}}c.remove();var e=ZSSEditor.getJoinedFocusedFieldIdAndCaretArguments();ZSSEditor.callback("input-change",e)};ZSSField.prototype.getImagesForCallback=function(){var b="function=getImagesForCallback";var a="id="+this.getNodeId();var d="contents="+this.getImages();var c=b+defaultCallbackSeparator+a+defaultCallbackSeparator+d;ZSSEditor.callback("callback-response-string",c)};ZSSField.prototype.getVideosForCallback=function(d){var b="function=getVideosForCallback";var a="id="+this.getNodeId();var e="contents="+this.getVideos(d);var c=b+defaultCallbackSeparator+a+defaultCallbackSeparator+e;ZSSEditor.callback("callback-response-string",c)};ZSSField.prototype.checkWhetherChangeToLink=function(j){if(/wenda/i.test(navigator.userAgent)&&/Android/i.test(navigator.userAgent)){return}var k=window.getSelection();var i=k.getRangeAt(0);var b=i.startContainer;var g=i.endContainer;if(g.nodeType==3&&b==g&&i.startOffset==i.endOffset&&$(g).parents("span[id^=link]").length==0&&$(g).parents("a").length==0){var h=g.data;var c=i.endOffset;var f=h.substring(0,c);var e=/((http|https)\:\/\/)?@?[\w\.]*\.([a-z]+)(\/[\x00-\xff]*)?(\s|[^\x00-\xff])+$/i;if(j){var e=/((http|https)\:\/\/)?@?[\w\.]*\.([a-z]+)(\/[\x00-\xff]*)?$/i}if(e.test(f)){var a=Math.random()+"";a=a.replace(/^\d\./,"");h=h.substring(c);var l=false;f=f.replace(e,function(m){m=m.replace(/(\s|[^\x00-\xff])+$/g,function(o,p){h=o+h;return""});var n=m;if(!/^http/i.test(n)){if(/^@/.test(n)){l=true}n="http://"+n}else{if(/^(http|https)\:\/\/@/i.test(n)){l=true}}return'<span id="link'+a+'" href="'+n+'" class="link-span">'+m+"</span>"});if(l){return}if(!h.length){h=h+"\xa0"}g.data=h;var i=document.createElement("div");i.innerHTML=f;var d=i.childNodes;$(d).insertBefore(g);this.checkLinkHref(a);var i=document.createRange();i.setStart(g,h.length);i.setEnd(g,h.length);k.removeAllRanges();k.addRange(i)}}};ZSSField.prototype.checkWhetherPopAt=function(){if(this.isComposing){return}var c=window.getSelection();var b=c.getRangeAt(0);if(!b){return}var e=b.startContainer;var a=b.endContainer;if(e==a&&b.startOffset==b.endOffset&&a.data){var d=a.data.substring(b.endOffset,b.endOffset-1);if(d=="@"){setTimeout(function(){ZSSEditor.callback("callback-pop-at")},10)}}};ZSSField.prototype.setAt=function(e,l,q,d){ZSSEditor.restoreRange();if(e==1||e==-1){this.wrapCaretInParagraphIfNecessary();var p=window.getSelection();var i=p.getRangeAt(0);if(!i){return}var r=i.endContainer;if(r.parentNode&&r.parentNode.tagName=="A"){r=r.parentNode}var m=r.data||"";var c=m.substring(i.endOffset,i.endOffset-1);var k,j;if(c=="@"){k=m.substring(0,i.endOffset-1)||"";j=m.substr(i.endOffset)||""}else{k=m.substring(0,i.endOffset);j=m.substr(i.endOffset)}k=k.replace(/\u200b$/,"");var g=document.createTextNode(k);var f;if(d){f=document.createTextNode(j)}else{f=document.createTextNode("\xa0"+j)}var o;if(e==1){o=$('<a href="https://www.wukong.com/user/?uid='+l+'" target="_blank" class="link-at" data-uid="'+l+'"></a> ');o.text("@"+q)}if(e==-1){o=document.createTextNode("@"+q);o=$(o)}if(r.tagName=="A"){$(f).insertAfter(r);o.insertAfter(r);$(g).insertAfter(r)}else{if(m){var b=document.createRange();b.setStartAfter(r);b.insertNode(f);b.insertNode(o[0]);b.insertNode(g);p.removeAllRanges();p.addRange(b);r.data=""}else{i.insertNode(f);i.insertNode(o[0])}}var n=document.createRange();p.removeAllRanges();n.setStart(f,1);n.setEnd(f,1);p.addRange(n);var h=ZSSEditor.getJoinedFocusedFieldIdAndCaretArguments();this.callback("callback-input",h);ZSSEditor.selectionChangedCallback()}};ZSSField.prototype.cancelAt=function(){var c=window.getSelection();var a=c.getRangeAt(0);var d=a.startContainer;var f;if(this.isLinkAt(d)){f=d}else{if(this.isLinkAt($(d).closest("a")[0])){f=$(d).closest("a")[0]}}if(f){var e=document.createTextNode(f.innerText);$(e).insertBefore(f);var b=document.createRange();b.setStart(e,a.startOffset);b.setEnd(e,a.endOffset);$(f).remove();c.removeAllRanges();c.addRange(b);return true}};ZSSField.prototype.checkLinkHref=function(e){var b=$("#link"+e);var a=b.attr("href");var d=this;function c(o){if(o.err_no==0&&o.link_data.is_legal==1){var g=document.createElement("a");g.className="out-link";g.href=a;g.target="_blank";g.innerHTML=o.link_data.title||a;g.id="link"+e;$(g).insertBefore(b);var n=b.text().split(" ");var l="\xa0";if(n.length>1){l+=n.slice(1).join(" ")}var f=document.createTextNode(l);$(f).insertBefore(b);var m=window.getSelection();var k=m.getRangeAt(0);var j=d.isEmptyRange(k)&&k.startContainer.previousSibling&&d.isOutLink(k.startContainer.previousSibling);b.remove();if(j){var i=document.createRange();i.setStart(f,l.length);i.setEnd(f,l.length);m.removeAllRanges();m.addRange(i)}}else{var h=document.createTextNode(b.text());$(h).insertBefore(b);b.remove()}}$.ajax({url:"https://lf.snssdk.com/wenda/v1/link/check/",type:"GET",dataType:"json",data:{link:a},success:c})};var longTapTimer=undefined,editingLinkID=undefined,touchingLinkID=undefined;ZSSField.prototype.touchStart=function(b){b=b.originalEvent;var d=b.touches;if(d.length>1){clearTimeout(longTapTimer);touchingLinkID=undefined;return}var c=b.target;var a=$(c).parents(".link-edit-tip");if(!a.length){$(".link-edit-tip").remove();$(".editing").removeClass("editing")}if(!/^link\d+$/i.test(b.target.id)||b.target.tagName!=="A"){return}touchingLinkID=b.target.id;clearTimeout(longTapTimer);longTapTimer=setTimeout(function(){this.popupLinkEditTip(b.target.id);touchingLinkID=undefined;this.callback("callback-show-edit")}.bind(this),800);b.preventDefault()};ZSSField.prototype.clickOutLink=function(a){var b=$(a.target).attr("id");this.popupLinkEditTip(b)};ZSSField.prototype.popupLinkEditTip=function(a){$(".link-edit-tip").remove();$(".editing").removeClass("editing");var h=$("#"+a);var e=h.offset();var f=140;var i=$('<div class="link-edit-tip" data-id="'+a+'"><div class="triangle"></div><span class="tip-open">打开</span><i></i><span class="tip-edit">编辑</span><i></i><span class="tip-del">删除</span></div>');var c=e.left+h.width()/2-f/2;var d=0;if(c<5){d=c-5;c=5}else{var b=$(window).width();var g=b-5;if(c+f>g){d=c+f-g;c=g-f}}i.css("left",c+"px");if(d){i.find(".triangle").css("transform","translate("+d+"px,0)")}i.css("top",e.top+h.height()+11+"px");i.appendTo("body");h.addClass("editing")};ZSSField.prototype.handleClick=function(d){var e=d.target;if($(e).is(".out-link")){var g=$(d.target).attr("id");this.popupLinkEditTip(g);d.preventDefault();return}var c=$(e).parents(".link-edit-tip");var g=c.attr("data-id");var b=$("#"+g);if(c.length&&e.tagName=="SPAN"){if(e.className=="tip-edit"){editingLinkID=g;setTimeout(function(){ZSSEditor.callback("callback-edit-link",["text=",b.text(),defaultCallbackSeparator,"link=",b.attr("href")].join(""));c.remove()},400)}if(e.className=="tip-del"){$("#"+g).remove();$(".link-edit-tip").remove();$(".editing").removeClass("editing");this.emptyFieldIfNoContents();setTimeout(function(){c.remove()},400)}if(e.className=="tip-open"){var a=b.attr("href");var f=b.text();$(".link-edit-tip").remove();$(".editing").removeClass("editing");location.href="sslocal://webview?url="+encodeURIComponent(a)+"&title="+encodeURIComponent(f)}}else{$(".link-edit-tip").remove();$(".editing").removeClass("editing")}if(!isUsingAndroid&&e.tagName==="BODY"){this.focusRangeEnd(true);this.focus()}};ZSSField.prototype.touchEnd=function(b){clearTimeout(longTapTimer);b=b.originalEvent;if(b.touches.length>0){touchingLinkID=undefined;return}if(b.target.id==touchingLinkID){var c=$(b.target);var a=c.attr("href");var d=c.text();location.href="sslocal://webview?url="+encodeURIComponent(a)+"&title="+encodeURIComponent(d)}};ZSSEditor.setLink=function(c,b,d){if(c==1){var a=$("#"+editingLinkID);a.attr("href",b);a.html(d)}};ZSSField.prototype.getEditorStatus=function(){var a=this.wrappedObject.text().replace(/[\s\u00a0\u200b]/g,""),c=a.length?1:0,b=this.wrappedObject.find("img").length?2:0;c=this.wrappedObject.find("video").length?1:c;return c+b};ZSSField.prototype.getEditorStatusForCallback=function(){var b="function=getEditorStatusForCallback";var a="id="+this.getNodeId();var d="contents="+this.getEditorStatus();var c=b+defaultCallbackSeparator+a+defaultCallbackSeparator+d;ZSSEditor.callback("callback-response-string",c)};ZSSField.prototype.getEditorText=function(){var a=this.wrappedObject.text().replace(/[\s\u00a0\u200b]/g,"");if(!a&&this.wrappedObject.find("video").length){a="video:"}return a};ZSSField.prototype.getEditorTextForCallback=function(){var b="function=getEditorTextForCallback";var a="id="+this.getNodeId();var d="contents="+this.getEditorText();var c=b+defaultCallbackSeparator+a+defaultCallbackSeparator+d;ZSSEditor.callback("callback-response-string",c)};ZSSEditor.setDayMode=function(a){if(["0","1",0,1].indexOf(a)<0){return}var b=$(document.body);a=parseInt(a);a?b.removeClass("night"):b.addClass("night")};ZSSEditor.deleteImageWhenPressDownBackspaceIfNecessary=function(){var b=window.getSelection();if(b.rangeCount){var a=b.getRangeAt(0),e=a.endContainer,c=a.endOffset;if(e.nodeType==1&&c>0){var d=e.childNodes[c-1];if(d.nodeName.toLowerCase()=="img"){e.removeChild(d)}}}};ZSSEditor.deleteVideoWhenPressDownBackspaceIfNecessary=function(){var b=window.getSelection();if(b.rangeCount){var a=b.getRangeAt(0),e=a.endContainer,c=a.endOffset;if(e.nodeType==1&&c>0){var d=e.childNodes[c-1];if(d.nodeName.toLowerCase()=="video"){e.removeChild(d)}}}};ZSSEditor.scrollTop=function(a){window.scrollTo(0,a)};ZSSEditor.keyboardPopUp=function(){var b=this.getYCaretInfo();var a=$(window).height();var c=b.y;c=c-a+b.height+5;this.scrollTop(c)};filterRules=function(){function a(b){b.tagName="p";b.attrs={};b.style=""}return{script:"-",style:"-",object:"-",iframe:"-",meta:"-",embed:"-",input:"-",select:"-",p:{span:0,$:{}},span:{"$":{}},div:{"$":{}},img:{"$":{src:1,id:1}},strong:{"$":{}},ul:{"$":{}},u:{"$":{}},ol:{"$":{}},li:{p:0,"$":{}},blockquote:{$:{}},code:{$:{}},h1:{"$":{}}}}();function isFunction(a){return(!!a&&!a.nodename&&a.constructor!=String&&a.constructor!=RegExp&&a.constructor!=Array&&/function/i.test(a+""))}function getNodeIndex(c,b){var d=c,a=0;while(d=d.previousSibling){if(b&&d.nodeType==3){if(d.nodeType!=d.nextSibling.nodeType){a++}continue}a++}return a}function filterNode(e){switch(e.nodeType){case 3:break;case 1:var a=e.tagName.toLowerCase();var f;if(f=filterRules[a]){if(f=="-"){e.parentNode.removeChild(e)}else{var d=0;var g=0;if(e.style.fontWeight=="bold"){d=1}if(e.style.textDecoration=="underline"){g=1}e.setAttribute("style","");if(d){e.style.fontWeight="bold"}if(g){e.style.textDecoration="underline"}if(e.childNodes.length>0){for(var c=0,b;b=e.children[c];){filterNode(b,filterRules);if(b.parentNode){c++}}}}}return e}}$(document).on("click","video",function(){ZSSEditor.$editor.blur()});ZSSEditor.marginTop=function(a){ZSSEditor.$editor.css("margin-top",a+"px")};$(document).on("click",function(){ZSSEditor.viewPortClickCallback()});ZSSEditor.viewPortClickCallback=function(){var a="";this.callback("callback-click-viewport",a)};$(document).on("click",".delete-icon",function(d){var c=$(this);var b=c.next()[0];if(b.tagName=="VIDEO"){var a=$(b).attr("data-vid");ZSSEditor.deleteVideoById(a)}});function winAlert(a){setTimeout(function(){alert(a)},100)}ZSSField.prototype.emptyFieldIfNoContents=function(){var f=this.wrappedObject.text().replace(/[\s\u00a0\u200b]/g,""),e=false;if(f.length==0){var b=(this.wrappedObject.find("img").length>0||this.wrappedObject.find("video").length>0);if(!b){this.wrappedObject.empty();var c=window.getSelection();c.removeAllRanges();var a=document.createRange();var d=this.wrappedObject[0];a.setStart(d,0);a.setEnd(d,0);c.addRange(a);e=true}}return e};